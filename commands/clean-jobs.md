# バックグラウンドジョブクリーンアップコマンド

> **バージョン**: 1.0.0
> **作成日**: 2025-11-10
> **更新日**: 2025-11-10
> **関連コマンド**: `/web-dev`, `/api-dev`, `/ds-notebook`（バックグラウンドプロセス起動系）

## 概要

現在のClaude Codeセッションで作成されたバックグラウンドジョブのみを安全にクリーンアップします。
他のClaude Codeセッションには影響しません。

**想定ユースケース**:
- 長時間の開発セッション後のクリーンアップ
- `/web-dev` 等のプロセス起動後の手動停止
- メモリ節約のための定期的なジョブ整理

## Claude Code 実装ノート

このスラッシュコマンドはClaude Codeによって実行されるため、以下の動作になります:

1. **Bash tool使用**: `jobs -l` 等のコマンド実行
2. **AskUserQuestion tool使用**: 選択肢提示（全削除/個別/キャンセル）
3. **対話的フロー**: ユーザーの選択に応じて動的に処理

## 実行フロー

1. 現在のセッションのバックグラウンドジョブを確認
2. ジョブ一覧をユーザーに提示
3. クリーンアップ方法を選択肢として提示
4. 選択に応じて実行

## 手順

### ステップ1: 現在のジョブ確認

まず、`jobs -l` で現在のセッションのバックグラウンドジョブを確認してください。

```bash
jobs -l
```

**ジョブが0件の場合:**
以下を表示して終了：
```
✅ クリーンアップするバックグラウンドジョブはありません
```

### ステップ2: クリーンアップ選択肢を提示

**ジョブが存在する場合:**

AskUserQuestion ツールを使用して以下の選択肢を提示：

```json
{
  "questions": [{
    "question": "バックグラウンドジョブのクリーンアップ方法を選択してください",
    "header": "クリーンアップ",
    "multiSelect": false,
    "options": [
      {
        "label": "全てクリーンアップ",
        "description": "現在のセッションの全ジョブをkillします"
      },
      {
        "label": "個別選択",
        "description": "特定のジョブ番号を指定してkillします"
      },
      {
        "label": "キャンセル",
        "description": "何もせずに終了します"
      }
    ]
  }]
}
```

### ステップ3: 実行

選択に応じて以下を実行：

#### 全てクリーンアップの場合

```bash
# 全ジョブをkill
if jobs -p | xargs kill 2>&1; then
    echo "✅ 全てのジョブをクリーンアップしました"
else
    echo "⚠️  一部のジョブのクリーンアップに失敗しました"
    jobs -l  # 残っているジョブを表示
fi
```

#### 個別選択の場合

ユーザーに以下を質問：
```
クリーンアップするジョブ番号を入力してください（スペース区切り、例: 1 3 5）:
```

**入力例**: `1 3 5`

```bash
# ユーザー入力を受け取る
read -p "クリーンアップするジョブ番号（スペース区切り）: " job_numbers

# 入力検証：数字とスペースのみ許可
if [[ ! "$job_numbers" =~ ^[0-9\ ]+$ ]]; then
    echo "❌ エラー: ジョブ番号は数字とスペースのみ指定してください（例: 1 3 5）"
    exit 1
fi

# 各ジョブをkill
killed_count=0
failed_count=0

for job_num in $job_numbers; do
    if kill %$job_num 2>/dev/null; then
        ((killed_count++))
    else
        ((failed_count++))
        echo "⚠️  ジョブ #$job_num のクリーンアップに失敗しました"
    fi
done

echo "✅ $killed_count 個のジョブをクリーンアップしました"
if [[ $failed_count -gt 0 ]]; then
    echo "⚠️  $failed_count 個のジョブのクリーンアップに失敗しました"
fi
```

#### キャンセルの場合

何もせずに終了します。

### ステップ4: 結果確認とレポート

クリーンアップ後の状態を確認して報告：

```bash
# クリーンアップ後の確認
remaining_jobs=$(jobs -l)

if [[ -z "$remaining_jobs" ]]; then
    echo "🎉 全てのバックグラウンドジョブがクリーンアップされました"
else
    echo "📋 残りのジョブ:"
    jobs -l
fi
```

## 注意事項

- このコマンドは**現在のセッション**のジョブのみに影響します
- 他のClaude Codeセッションや別のターミナルのプロセスには影響しません
- 実行中の重要なタスクがある場合は、個別選択を推奨します

## テスト方法

### 手動テスト手順

#### 1. 準備: バックグラウンドジョブの作成
```bash
# テスト用のダミージョブを起動
sleep 300 &
sleep 400 &
sleep 500 &
jobs -l  # 3つのジョブが表示されることを確認
```

#### 2. 個別削除のテスト
```bash
/clean-jobs
# → "個別選択" を選択
# → "1 3" と入力
# → ジョブ1,3が削除され、ジョブ2が残ることを確認
```

#### 3. 全削除のテスト
```bash
/clean-jobs
# → "全てクリーンアップ" を選択
# → 全ジョブが削除されることを確認
```

#### 4. ジョブ0件時のテスト
```bash
/clean-jobs
# → "クリーンアップするジョブはありません" が表示されることを確認
```

### 期待される動作

- ✅ 現在のセッションのジョブのみ表示・削除
- ✅ 他のターミナル・セッションのジョブには影響なし
- ✅ 無効な入力時は適切なエラーメッセージ
- ✅ 部分的失敗時も成功したジョブ数を報告

## 将来的な拡張案

### Phase 2: フィルタリング機能
- コマンド名でのフィルタリング（例: sleep プロセスのみ）
- 実行時間でのフィルタリング（例: 1時間以上のジョブのみ）

### Phase 3: 自動クリーンアップ
- 一定時間経過後の自動クリーンアップ
- `/web-dev` 終了時の自動実行

### Phase 4: 統計・レポート
- セッション中のジョブ起動履歴
- リソース使用状況のサマリー
